<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGL Clone</title>
    <style>
         body {
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f7f7f7;
            margin: 0;
            padding: 20px;
        }

        #container {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 450px;
            width: 100%;
            padding: 30px;
            text-align: center;
            box-sizing: border-box;
            position: relative; /* Untuk positioning tombol logout */
        }

        h1 {
            color: #333;
            margin-bottom: 10px; /* Jarak lebih kecil */
        }
        h2 {
            color: #555;
            margin-bottom: 20px;
            font-size: 1.1em; /* Sedikit lebih kecil dari h1 */
            font-weight: normal; /* Tidak terlalu tebal */
        }

        .section {
            margin-bottom: 25px;
        }

        input[type="text"],
        textarea,
        input[type="username"],
        input[type="url"] { /* Tambahkan input[type="url"] */
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        button {
            background-color: #8a2be2;
            color: #fff;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            display: inline-block; /* Agar tombol copy dan salin sejajar */
            margin: 0 5px; /* Beri sedikit jarak antar tombol */

        }

        button:hover {
            background-color: #6a1b9a;
        }

        #messages {
            margin-top: 20px;
        }

        .message {
            background-color: #eee;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            text-align: left;
        }

        #userLinkDisplay {
            margin-top: 15px;
            word-break: break-all; /* URL panjang tidak merusak layout */
            color: #555;

        }

        #copyUrlSection {
            display: flex; /* Agar input dan tombol sejajar */
            align-items: center; /* Pusatkan vertikal */
            margin-bottom: 15px;
        }
        #copyUrlSection input{
            margin-bottom: 0px;
        }

        #sendResult {
            color: green;
        }

        #error-message {
            color: red;
            margin-top: 10px;
        }
        #logoutBtn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #ccc;
            color: #333;
        }

        @media (max-width: 600px) {
            #container {
                padding: 20px;
            }
             button {
                display: block; /* Tombol jadi blok di layar kecil */
                width: 100%;     /* Lebar penuh */
                margin: 5px 0;    /* Jarak atas-bawah */
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="container">
        <h1>NGL Clone</h1>

        <button id="logoutBtn" style="display: none;">Logout</button>

        <!-- Bagian: Daftar -->
        <div id="registerSection" class="section">
            <h2>Register</h2>
            <input type="username" id="registerUsername" placeholder="Enter your username">
            <button id="registerBtn">Register</button>
            <p id="error-message"></p>
        </div>

        <!-- Bagian: Inbox (Setelah Daftar) -->
        <div id="linkAndInboxSection" class="section" style="display: none;">
            <h2>Your Inbox</h2>
              <div id="copyUrlSection">
                <input type="url" id="userLinkInput" readonly>
                <button id="copyUrlBtn">Copy URL</button>
            </div>
            <button id="refreshBtn">Refresh Messages</button>
            <div id="messages"></div>
        </div>

        <!-- Bagian: Kirim Pesan -->
        <div id="sendMessageSection" class="section" style="display: none;">
           <h2 id="sendMessageTitle">Send Anonymous Message</h2>
            <textarea id="messageInput" placeholder="Your message..."></textarea>
            <button id="sendBtn">Send</button>
            <p id="sendResult"></p>
        </div>
    </div>

    <script>
      const registerSection = document.getElementById('registerSection');
        const registerUsernameInput = document.getElementById('registerUsername');
        const registerBtn = document.getElementById('registerBtn');
        const linkAndInboxSection = document.getElementById('linkAndInboxSection');
        const userLinkInput = document.getElementById('userLinkInput');
        const copyUrlBtn = document.getElementById('copyUrlBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const messagesDiv = document.getElementById('messages');
        const sendMessageSection = document.getElementById('sendMessageSection');
        const sendMessageTitle = document.getElementById('sendMessageTitle');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const sendResult = document.getElementById('sendResult');
		const errorMessage = document.getElementById('error-message');
        const logoutBtn = document.getElementById('logoutBtn');



        // --- Fungsi-fungsi Bantu ---

        function showSection(section) {
            registerSection.style.display = 'none';
            linkAndInboxSection.style.display = 'none';
            sendMessageSection.style.display = 'none';
            section.style.display = 'block';
        }

        function setupLinkAndInbox(username) {
            const userLink = `${window.location.origin}/user/${username}`;
            userLinkInput.value = userLink;
        }

        async function loadMessages() {
             const currentUsername = localStorage.getItem('username');
            if (!currentUsername) {
                showSection(registerSection);
                return;
            }

            const response = await fetch(`/api/messages/${currentUsername}`);
            const data = await response.json();

            if (response.ok) {
                messagesDiv.innerHTML = data.messages.map(msg => `<div class="message">${msg.text}</div>`).join('');
            } else {
                messagesDiv.innerHTML = 'Error loading messages.';
            }
        }


        function checkLocalStorage() {
            const username = localStorage.getItem('username');
            if (username) {
                showSection(linkAndInboxSection);
                setupLinkAndInbox(username); // Sekarang panggil dengan username
                loadMessages();
                logoutBtn.style.display = 'block';
            } else {
                showSection(registerSection);
            }
        }


        // --- Event Listeners ---

        registerBtn.addEventListener('click', async () => {
           const username = registerUsernameInput.value;
			errorMessage.textContent = "";
            if (!username) {
                errorMessage.textContent = "Please enter a username";
                return;
            }

            const response = await fetch('/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username }),
            });
            const data = await response.json();

            if (response.ok) {
                // Simpan HANYA username di localStorage
                localStorage.setItem('username', data.username);
                showSection(linkAndInboxSection);
                setupLinkAndInbox(data.username); // Kirim username
                loadMessages();
				logoutBtn.style.display = 'block';
            } else {
                errorMessage.textContent = data.error || 'Registration failed.';
            }
        });

        sendBtn.addEventListener('click', async () => {
            // Ambil username dari URL (bukan lagi userId)
            const username = window.location.pathname.split('/').pop(); // "/user/wanzofc" -> "wanzofc"
            const message = messageInput.value;

            if (!message) {
                sendResult.textContent = "Please enter a message";
                return;
            }
            sendResult.textContent = "Sending...";

            const response = await fetch(`/api/send/${username}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message }),
            });
            const result = await response.json();
             sendResult.textContent = "";
            if (response.ok) {
                messageInput.value = '';
                sendResult.textContent = 'Message sent successfully!';
            } else {
                 alert(result.error || 'Failed to send message.');
            }
        });

        refreshBtn.addEventListener('click', loadMessages);


        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('username');
            showSection(registerSection);
            logoutBtn.style.display = 'none';
        });

        copyUrlBtn.addEventListener('click', () => {
            userLinkInput.select();
            document.execCommand('copy');
            copyUrlBtn.textContent = 'Copied!';
            setTimeout(() => { copyUrlBtn.textContent = 'Copy URL'; }, 2000);
        });



        // --- Cek URL dan localStorage saat halaman dimuat ---

        const path = window.location.pathname; // "/user/wanzofc" atau "/"

        if (path.startsWith('/user/')) {
            // 1. Kita di halaman user (ada username di URL)
            const username = path.split('/').pop(); // Ambil username dari URL
             showSection(sendMessageSection);

            // 2. Ambil username dari SERVER untuk judul
            fetch(`/api/user/${username}`)
                .then(response => {
                    if (!response.ok) {
                      throw new Error('User Not Found');
                    }
                    return response.json()
                })
                .then(data => {
                    // 3. Set judul
                    sendMessageTitle.textContent = `Send Anonymous Message to ${data.username}`;
                })
                .catch(error => {
                     console.error("Error:", error);
                    sendMessageTitle.textContent = "Send Anonymous Message"; // Judul default
                });

        } else {
            // Kita di halaman utama (registrasi/inbox)
            checkLocalStorage();
        }
    </script>
</body>
</html>
