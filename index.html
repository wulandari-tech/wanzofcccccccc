<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGL Clone</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #121212;
            color: #fff;
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
        }
         #particles-js {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 0;
        }

        #container {
            background-color: #1e1e1e;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            max-width: 450px;
            width: 100%;
            padding: 30px;
            text-align: center;
            box-sizing: border-box;
            position: relative;
            z-index: 1;
        }

        h1 {
            color: #fff;
            margin-bottom: 10px;
        }

        h2 {
            color: #ddd;
            margin-bottom: 20px;
            font-size: 1.1em;
            font-weight: normal;
        }

        .section {
            margin-bottom: 25px;
        }

        input[type="text"],
        textarea,
        input[type="username"],
        input[type="url"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #444;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            background-color: #2a2a2a;
            color: #fff;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus,
        textarea:focus,
        input[type="username"]:focus,
        input[type="url"]:focus {
            border-color: #8a2be2;
            outline: none;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        button {
            background-color: #8a2be2;
            color: #fff;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            display: inline-block;
            margin: 0 5px;
        }

        button:disabled {
            background-color: #444;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
             background-color: #6a1b9a;
        }

        #messages {
            margin-top: 20px;
        }

        .message {
            background-color: #2a2a2a;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            text-align: left;
            display: flex;
            align-items: flex-start;
        }

        .message-content {
            flex-grow: 1;
        }

        #userLinkDisplay {
            margin-top: 15px;
            word-break: break-all;
            color: #ddd;
        }

        #copyUrlSection {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
       #copyUrlSection input{
            margin-bottom: 0px;
        }

        #sendResult {
            color: #4CAF50;
        }

        #error-message {
            color: #f44336;
            margin-top: 10px;
        }

        #logoutBtn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #444;
            color: #fff;
        }

        @media (max-width: 600px) {
            #container {
                padding: 20px;
            }

            button {
                display: block;
                width: 100%;
                margin: 5px 0;
            }
        }

          .message-box {
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            text-align: center;
            color: #fff;
        }

        .success-message {
            background-color: #4CAF50;
            border: 1px solid #388E3C;

        }

        .error-message {
            background-color: #f44336;
            border: 1px solid #d32f2f;

        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            border-radius: 12px;
            z-index: 10;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8a2be2;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        form {
            width: 100%;
        }

        .avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #8a2be2;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
            font-size: 14px;
        }

        .message-timestamp {
            font-size: 0.8em;
            color: #aaa;
            margin-top: 4px;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
</head>
<body>
    <div id="particles-js"></div>
    <div id="container">
        <h1>NGL Clone</h1>
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loader"></div>
        </div>

        <button id="logoutBtn" style="display: none;">Logout</button>

        <div id="registerSection" class="section">
            <h2>Register</h2>
            <form id="registerForm">
                <input type="username" id="registerUsername" placeholder="Enter your username" required>
                <button type="submit">Register</button>
                <div id="registerMessage" class="message-box" style="display: none;"></div>
            </form>
        </div>

          <div id="linkAndInboxSection" class="section" style="display: none;">
            <h2>Your Inbox</h2>
            <div id="copyUrlSection">
                <input type="url" id="userLinkInput" readonly>
                <button id="copyUrlBtn">Copy URL</button>
            </div>
            <button id="refreshBtn">Refresh Messages</button>
            <div id="messages"></div>
        </div>

        <div id="sendMessageSection" class="section" style="display: none;">
            <h2 id="sendMessageTitle">Send Anonymous Message</h2>
             <form id="sendMessageForm">
                <textarea id="messageInput" placeholder="Your message..." required></textarea>
                <button type="submit">Send</button>
                <div id="sendMessageResult" class="message-box" style="display: none;"></div>
            </form>
        </div>
    </div>

    <script>
        particlesJS('particles-js', {
            particles: {
                number: { value: 80, density: { enable: true, value_area: 800 } },
                color: { value: ['#8a2be2', '#00ffff', '#00ff00', '#ffff00', '#ff00ff'] },
                shape: { type: 'circle', stroke: { width: 0, color: '#000000' }, polygon: { nb_sides: 5 } },
                opacity: { value: 0.5, random: true, anim: { enable: false, speed: 1, opacity_min: 0.1, sync: false } },
                size: { value: 3, random: true, anim: { enable: true, speed: 10, size_min: 0.1, sync: false } },
                line_linked: { enable: true, distance: 150, color: '#8a2be2', opacity: 0.4, width: 1 },
                move: {
                    enable: true,
                    speed: 2,
                    direction: 'none',
                    random: true,
                    straight: false,
                    out_mode: 'out',
                    bounce: false,
                },
            },
            interactivity: {
                detect_on: 'canvas',
                events: { onhover: { enable: true, mode: 'repulse' }, onclick: { enable: true, mode: 'push' }, resize: true },
                modes: {
                    grab: { distance: 400, line_linked: { opacity: 1 } },
                    bubble: { distance: 400, size: 40, duration: 2, opacity: 8, speed: 3 },
                    repulse: { distance: 100, duration: 0.4 },
                    push: { particles_nb: 4 },
                    remove: { particles_nb: 2 },
                },
            },
            retina_detect: true,
        });

        const registerSection = document.getElementById('registerSection');
        const registerForm = document.getElementById('registerForm');
        const registerUsernameInput = document.getElementById('registerUsername');
        const registerMessage = document.getElementById('registerMessage');
        const linkAndInboxSection = document.getElementById('linkAndInboxSection');
        const userLinkInput = document.getElementById('userLinkInput');
        const copyUrlBtn = document.getElementById('copyUrlBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const messagesDiv = document.getElementById('messages');
        const sendMessageSection = document.getElementById('sendMessageSection');
        const sendMessageForm = document.getElementById('sendMessageForm');
        const sendMessageTitle = document.getElementById('sendMessageTitle');
        const messageInput = document.getElementById('messageInput');
        const sendMessageResult = document.getElementById('sendMessageResult');
        const logoutBtn = document.getElementById('logoutBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');

        function showSection(section) {
            registerSection.style.display = 'none';
            linkAndInboxSection.style.display = 'none';
            sendMessageSection.style.display = 'none';
            section.style.display = 'block';

            gsap.from(section, { opacity: 0, y: -20, duration: 0.5, ease: 'power2.out' });
        }

        function showLoading() {
            loadingOverlay.style.display = 'flex';
            document.querySelectorAll('button').forEach(button => button.disabled = true);

        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
            document.querySelectorAll('button').forEach(button => button.disabled = false);

        }

        function showMessage(element, message, isSuccess = true) {
            element.textContent = message;
            element.style.display = 'block';
            element.className = isSuccess ? 'message-box success-message' : 'message-box error-message';
        }

        function hideMessage(element) {
            element.style.display = 'none';
        }

        function setupLinkAndInbox(username) {
            const userLink = `${window.location.origin}/user/${username}`;
            userLinkInput.value = userLink;
        }

        function getAvatarText(username) {
            return username.charAt(0).toUpperCase();
        }

        function generateAvatarColor(username) {
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            const color = `hsl(${hash % 360}, 70%, 60%)`;
            return color;
        }

        function displayMessage(message) {
             const currentUsername = localStorage.getItem('username');
            const avatarText = getAvatarText(currentUsername);
            const avatarColor = generateAvatarColor(currentUsername);

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';

            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'avatar';
            avatarDiv.textContent = avatarText;
            avatarDiv.style.backgroundColor = avatarColor;

            const messageContentDiv = document.createElement('div');
            messageContentDiv.className = 'message-content';

            const textDiv = document.createElement('div');
            textDiv.textContent = message.text;

            const timestampDiv = document.createElement('div');
            timestampDiv.className = 'message-timestamp';
            timestampDiv.textContent = formatTimestamp(message.timestamp);

            messageContentDiv.appendChild(textDiv);
            messageContentDiv.appendChild(timestampDiv);

            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(messageContentDiv);

            messagesDiv.appendChild(messageDiv);

            gsap.from(messageDiv, { opacity: 0, x: -20, duration: 0.3, ease: 'power2.out' });
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);

            if (diffInSeconds < 60) {
                return 'just now';
            } else if (diffInSeconds < 3600) {
                return Math.floor(diffInSeconds / 60) + ' minutes ago';
            } else if (diffInSeconds < 86400) {
                return Math.floor(diffInSeconds / 3600) + ' hours ago';
            } else {
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
            }
        }

        async function loadMessages() {
            const currentUsername = localStorage.getItem('username');
            if (!currentUsername) {
                showSection(registerSection);
                return;
            }

            showLoading();
            try {
                const response = await fetch(`/api/messages/${currentUsername}`);
                const data = await response.json();

                if (response.ok) {
                    messagesDiv.innerHTML = '';
                    data.messages.forEach(displayMessage);
                } else {
                    showMessage(registerMessage,`Error loading messages: ${response.statusText}`, false)
                }
            } catch(error) {
                showMessage(registerMessage, `Error: ${error.message}`, false);
            } finally {
                hideLoading();
            }
        }

       function checkLocalStorage() {
            const username = localStorage.getItem('username');
            if (username) {
                showSection(linkAndInboxSection);
                setupLinkAndInbox(username);
                loadMessages();
                logoutBtn.style.display = 'block';
            } else {
                showSection(registerSection);
            }
        }

        registerForm.addEventListener('submit', async (event) => {
             event.preventDefault();
            const username = registerUsernameInput.value;

            hideMessage(registerMessage);
            showLoading();

            try{
                const response = await fetch('/api/register', {
                    method : 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username}),
                });
                const data = await response.json();

                if(response.ok){
                    localStorage.setItem('username', data.username);
                    showSection(linkAndInboxSection);
                    setupLinkAndInbox(data.username);
                    loadMessages();
                    logoutBtn.style.display = 'block';
                } else {
                    showMessage(registerMessage, data.error || 'Registration failed.', false);
                }
            } catch(error){
                showMessage(registerMessage, 'An unexpected error occurred.', false);

            } finally{
                hideLoading();
            }
        });

        sendMessageForm.addEventListener('submit', async (event) => {
           event.preventDefault();
            const username = window.location.pathname.split('/').pop();
            const message = messageInput.value;

            hideMessage(sendMessageResult);
            showLoading();

            try {
                const response = await fetch(`/api/send/${username}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message }),
                });
                const result = await response.json();

                if (response.ok) {
                    messageInput.value = '';
                    showMessage(sendMessageResult, 'Message sent successfully!', true);
                } else {
                    showMessage(sendMessageResult, result.error || 'Failed to send message.', false);
                }
            } catch (error) {
                showMessage(sendMessageResult, 'An unexpected error occurred.', false);
            } finally {
                hideLoading();
            }
        });

        refreshBtn.addEventListener('click', loadMessages);

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('username');
            showSection(registerSection);
            logoutBtn.style.display = 'none';
        });

        copyUrlBtn.addEventListener('click', () => {
             userLinkInput.select();
            document.execCommand('copy');
            copyUrlBtn.textContent = 'Copied!';
            setTimeout(() => { copyUrlBtn.textContent = 'Copy URL'; }, 2000);
        });

        const path = window.location.pathname;

        if (path.startsWith('/user/')) {
            const username = path.split('/').pop();
            showSection(sendMessageSection);

            fetch(`/api/user/${username}`)
            .then(response => {
                if(!response.ok){
                    throw new Error("user not found")
                }
                return response.json();
            })
            .then(data => {
                sendMessageTitle.textContent = `Send Anonymous Message to ${data.username}`;
            })
            .catch(error => {
                 sendMessageTitle.textContent = "Send Anonymous Message";
            })
        } else {
            checkLocalStorage();
        }
    </script>
</body>
</html>
